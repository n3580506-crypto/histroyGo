import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, addDoc, onSnapshot, 
  doc, deleteDoc, query 
} from 'firebase/firestore';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
} from 'firebase/auth';
import { 
  Home, PlayCircle, ClipboardList, User, Plus, 
  Trash2, Trophy, Coins, ChevronRight, LayoutDashboard, 
  Lock, Youtube, BookOpen, LogOut, CheckCircle2
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'orde-lama-app';

const App = () => {
  const [activeTab, setActiveTab] = useState('home');
  const [user, setUser] = useState(null);
  const [materi, setMateri] = useState([]);
  const [videos, setVideos] = useState([]);
  const [quizzes, setQuizzes] = useState([]);
  const [userCoins, setUserCoins] = useState(0);
  const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);

  // Inisialisasi Autentikasi
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error:", err);
      }
    };
    initAuth();
    
    const unsubscribeAuth = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) {
        setUserCoins(parseInt(localStorage.getItem('coins') || '0'));
      }
    });

    return () => unsubscribeAuth();
  }, []);

  // Fetch Data - Guarded by Auth
  useEffect(() => {
    if (!user) return;

    const handleError = (err) => console.error("Firestore Error:", err);

    const qMateri = query(collection(db, 'artifacts', appId, 'public', 'data', 'materi'));
    const unsubMateri = onSnapshot(qMateri, (snapshot) => {
      setMateri(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, handleError);

    const qVideos = query(collection(db, 'artifacts', appId, 'public', 'data', 'videos'));
    const unsubVideos = onSnapshot(qVideos, (snapshot) => {
      setVideos(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, handleError);

    const qQuizzes = query(collection(db, 'artifacts', appId, 'public', 'data', 'quizzes'));
    const unsubQuizzes = onSnapshot(qQuizzes, (snapshot) => {
      setQuizzes(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }, handleError);

    return () => {
      unsubMateri();
      unsubVideos();
      unsubQuizzes();
    };
  }, [user]);

  const addCoins = (amount) => {
    const newCoins = userCoins + amount;
    setUserCoins(newCoins);
    localStorage.setItem('coins', newCoins.toString());
  };

  const Navbar = () => (
    <div className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-3 z-50">
      <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center ${activeTab === 'home' ? 'text-orange-500' : 'text-gray-400'}`}>
        <Home size={22} />
        <span className="text-[10px] mt-1">Beranda</span>
      </button>
      <button onClick={() => setActiveTab('video')} className={`flex flex-col items-center ${activeTab === 'video' ? 'text-orange-500' : 'text-gray-400'}`}>
        <PlayCircle size={22} />
        <span className="text-[10px] mt-1">Video</span>
      </button>
      <button onClick={() => setActiveTab('quiz')} className={`flex flex-col items-center ${activeTab === 'quiz' ? 'text-orange-500' : 'text-gray-400'}`}>
        <ClipboardList size={22} />
        <span className="text-[10px] mt-1">Kuis</span>
      </button>
      <button onClick={() => setActiveTab('admin')} className={`flex flex-col items-center ${activeTab === 'admin' ? 'text-orange-500' : 'text-gray-400'}`}>
        <LayoutDashboard size={22} />
        <span className="text-[10px] mt-1">Admin</span>
      </button>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 pb-20 font-sans text-gray-800">
      {/* Header Ala Shopee */}
      <div className="bg-orange-500 p-4 sticky top-0 z-40 flex justify-between items-center text-white shadow-md">
        <div className="flex flex-col">
          <h1 className="font-bold text-lg italic tracking-tight underline">ORL-History</h1>
          <p className="text-[10px] opacity-80 uppercase tracking-wider font-semibold">Arsip Digital Orde Lama</p>
        </div>
        <div className="bg-orange-600 rounded-full px-3 py-1 flex items-center gap-1 border border-orange-400">
          <Coins size={14} className="text-yellow-300" />
          <span className="text-sm font-bold">{userCoins}</span>
        </div>
      </div>

      {!user ? (
        <div className="flex items-center justify-center h-[60vh]">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500"></div>
        </div>
      ) : (
        <div className="max-w-md mx-auto">
          {activeTab === 'home' && <HomeView materi={materi} />}
          {activeTab === 'video' && <VideoView videos={videos} />}
          {activeTab === 'quiz' && <QuizView quizzes={quizzes} onCorrect={addCoins} />}
          {activeTab === 'admin' && (
            <AdminView 
              db={db} 
              user={user} 
              appId={appId} 
              materi={materi} 
              videos={videos} 
              quizzes={quizzes} 
              isAuthenticated={isAdminAuthenticated}
              setAuthenticated={setIsAdminAuthenticated}
            />
          )}
        </div>
      )}

      <Navbar />
    </div>
  );
};

// --- VIEWS ---

const HomeView = ({ materi }) => {
  return (
    <div className="space-y-4 p-3">
      {/* Banner */}
      <div className="w-full h-44 bg-gradient-to-br from-orange-400 via-orange-500 to-red-600 rounded-2xl shadow-lg flex items-center justify-center relative overflow-hidden">
        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-xl"></div>
        <div className="text-center text-white p-4 z-10">
          <h2 className="font-black text-2xl leading-tight uppercase drop-shadow-md">Sejarah Bangsa</h2>
          <p className="text-[11px] opacity-90 mt-1 uppercase tracking-widest">Mengenal Lebih Dekat Orde Lama</p>
          <div className="mt-4 inline-block bg-white text-orange-600 font-bold text-[10px] px-5 py-2 rounded-full shadow-lg cursor-pointer active:scale-95 transition-all">
            LIHAT MATERI
          </div>
        </div>
      </div>

      {/* Kategori */}
      <div className="grid grid-cols-4 gap-3 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
        {[
          { label: 'Tokoh', icon: <User size={20} className="text-blue-500" />, color: 'bg-blue-50' },
          { label: 'Politik', icon: <BookOpen size={20} className="text-purple-500" />, color: 'bg-purple-50' },
          { label: 'Ekonomi', icon: <Coins size={20} className="text-orange-500" />, color: 'bg-orange-50' },
          { label: 'Militer', icon: <Trophy size={20} className="text-red-500" />, color: 'bg-red-50' },
        ].map((cat, i) => (
          <div key={i} className="flex flex-col items-center gap-1">
            <div className={`${cat.color} p-3.5 rounded-2xl transition-transform active:scale-90`}>
              {cat.icon}
            </div>
            <span className="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">{cat.label}</span>
          </div>
        ))}
      </div>

      {/* Materi Feed */}
      <h3 className="font-bold text-gray-700 px-1 text-sm flex items-center gap-2">
        <div className="w-1 h-4 bg-orange-500 rounded-full"></div> Materi Terbaru
      </h3>
      <div className="grid grid-cols-2 gap-3 pb-4">
        {materi.map((item) => (
          <div key={item.id} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full active:bg-gray-50 transition-colors">
            <div className="h-24 bg-gray-100">
               <img src={`https://picsum.photos/seed/${item.id}/200/200`} className="w-full h-full object-cover" alt={item.title} />
            </div>
            <div className="p-2.5 flex-grow flex flex-col">
              <h3 className="text-[11px] font-bold line-clamp-2 h-8 leading-tight text-gray-800">{item.title}</h3>
              <p className="text-[9px] text-gray-400 mt-1 line-clamp-2 leading-relaxed">{item.description}</p>
              <div className="mt-3 pt-2 border-t border-gray-50 flex items-center justify-between">
                <span className="text-orange-500 text-[9px] font-black uppercase">Pelajari</span>
                <ChevronRight size={10} className="text-orange-400" />
              </div>
            </div>
          </div>
        ))}
        {materi.length === 0 && <p className="col-span-2 text-center text-gray-400 py-12 text-xs italic">Belum ada konten sejarah.</p>}
      </div>
    </div>
  );
};

const VideoView = ({ videos }) => {
  return (
    <div className="p-3 space-y-4">
      <h2 className="font-bold flex items-center gap-2 text-gray-700 text-sm">
        <Youtube className="text-red-500" /> Galeri Dokumenter
      </h2>
      <div className="space-y-4">
        {videos.map((v) => (
          <div key={v.id} className="bg-white rounded-2xl shadow-sm border overflow-hidden">
            <div className="aspect-video bg-black">
              <iframe
                width="100%"
                height="100%"
                src={`https://www.youtube.com/embed/${v.youtubeId}`}
                title={v.title}
                frameBorder="0"
                allowFullScreen
              ></iframe>
            </div>
            <div className="p-3.5">
              <h3 className="font-bold text-xs text-gray-800">{v.title}</h3>
              <div className="flex items-center gap-2 mt-2">
                <span className="bg-red-50 text-red-600 text-[9px] px-2 py-0.5 rounded-full font-bold uppercase border border-red-100">Video Sejarah</span>
              </div>
            </div>
          </div>
        ))}
        {videos.length === 0 && <p className="text-center text-gray-400 py-12 text-xs italic">Daftar video masih kosong.</p>}
      </div>
    </div>
  );
};

const QuizView = ({ quizzes, onCorrect }) => {
  const [selectedQuiz, setSelectedQuiz] = useState(null);
  const [feedback, setFeedback] = useState(null);

  const handleAnswer = (choice) => {
    if (choice === selectedQuiz.correct) {
      setFeedback("BENAR! +10 Koin Berhasil Ditambahkan");
      onCorrect(10);
      setTimeout(() => {
        setFeedback(null);
        setSelectedQuiz(null);
      }, 1500);
    } else {
      setFeedback("SALAH! Baca kembali materi di Beranda.");
      setTimeout(() => setFeedback(null), 1000);
    }
  };

  return (
    <div className="p-3 space-y-4">
      <h2 className="font-bold flex items-center gap-2 text-gray-700 text-sm">
        <Trophy className="text-yellow-500" /> Tantangan Sejarah
      </h2>

      {!selectedQuiz ? (
        <div className="grid gap-3">
          {quizzes.map((q) => (
            <div key={q.id} onClick={() => setSelectedQuiz(q)} className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm flex justify-between items-center cursor-pointer active:scale-[0.98] transition-all">
              <div className="flex items-center gap-3">
                <div className="bg-orange-100 p-2.5 rounded-xl">
                  <ClipboardList size={20} className="text-orange-600" />
                </div>
                <div>
                  <h3 className="font-bold text-[13px] text-gray-800">{q.title}</h3>
                  <p className="text-[10px] text-green-500 font-bold uppercase tracking-wider">Hadiah: 10 Koin</p>
                </div>
              </div>
              <ChevronRight size={18} className="text-gray-300" />
            </div>
          ))}
          {quizzes.length === 0 && <p className="text-center text-gray-400 py-12 text-xs italic">Kuis baru akan segera hadir!</p>}
        </div>
      ) : (
        <div className="bg-white p-6 rounded-3xl shadow-xl border border-orange-50 animate-in fade-in slide-in-from-bottom-4 duration-500">
          <div className="flex justify-between items-center mb-6">
             <button onClick={() => setSelectedQuiz(null)} className="text-[10px] text-gray-400 uppercase font-black tracking-widest flex items-center gap-1 hover:text-orange-500">
              ‚Üê Kembali
            </button>
            <span className="text-[10px] bg-orange-500 text-white px-3 py-1 rounded-full font-bold uppercase">Level 1</span>
          </div>
          <h3 className="font-bold text-lg mb-8 leading-tight text-gray-800">{selectedQuiz.question}</h3>
          <div className="space-y-3">
            {selectedQuiz.options.map((opt, idx) => (
              <button
                key={idx}
                onClick={() => handleAnswer(idx)}
                className="w-full text-left p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-orange-500 hover:bg-orange-50 active:scale-95 transition-all text-[13px] font-semibold text-gray-700 flex justify-between items-center"
              >
                {opt}
                <div className="w-5 h-5 rounded-full border-2 border-gray-200" />
              </button>
            ))}
          </div>
          {feedback && (
            <div className={`mt-8 p-4 rounded-xl text-center font-black text-[10px] shadow-sm uppercase tracking-widest animate-bounce ${feedback.includes('BENAR') ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
              {feedback}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// --- ADMIN VIEW (With Protection) ---

const AdminView = ({ db, user, appId, materi, videos, quizzes, isAuthenticated, setAuthenticated }) => {
  const [tab, setTab] = useState('materi');
  const [formData, setFormData] = useState({ title: '', content: '', youtubeId: '', question: '', options: ['', '', '', ''], correct: 0 });
  const [pin, setPin] = useState('');
  const [error, setError] = useState('');

  // Password admin sederhana
  const adminPassword = 'admin123';

  const handleLogin = (e) => {
    e.preventDefault();
    if (pin === adminPassword) {
      setAuthenticated(true);
      setError('');
    } else {
      setError('Password Salah! Akses Ditolak.');
    }
  };

  const handleLogoutAdmin = () => {
    setAuthenticated(false);
    setPin('');
  };

  if (!isAuthenticated) {
    return (
      <div className="p-6 flex flex-col items-center justify-center min-h-[70vh]">
        <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mb-4 text-orange-500">
          <Lock size={32} />
        </div>
        <h2 className="text-xl font-black text-gray-800 mb-2">Login Admin</h2>
        <p className="text-xs text-gray-400 mb-6 text-center">Hanya administrator yang dapat mengelola konten aplikasi.</p>
        
        <form onSubmit={handleLogin} className="w-full max-w-xs space-y-4">
          <input
            type="password"
            placeholder="Masukkan Password Admin"
            className="w-full p-4 border rounded-2xl text-center text-sm font-bold tracking-[1em] focus:ring-2 focus:ring-orange-500 outline-none shadow-sm"
            value={pin}
            onChange={(e) => setPin(e.target.value)}
            required
          />
          {error && <p className="text-red-500 text-[10px] font-bold text-center uppercase tracking-wider">{error}</p>}
          <button className="w-full bg-orange-600 text-white py-4 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-lg active:scale-95 transition-all">
            Verifikasi
          </button>
        </form>
        <p className="mt-10 text-[9px] text-gray-300 uppercase font-bold tracking-widest italic">Hint: admin123</p>
      </div>
    );
  }

  // --- LOGIC TAMBAH DATA ---
  const handleAddMateri = async (e) => {
    e.preventDefault();
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'materi'), {
        title: formData.title,
        description: formData.content,
        createdAt: new Date().toISOString(),
      });
      setFormData({ ...formData, title: '', content: '' });
    } catch (err) { console.error(err); }
  };

  const handleAddVideo = async (e) => {
    e.preventDefault();
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'videos'), {
        title: formData.title,
        youtubeId: formData.youtubeId,
        createdAt: new Date().toISOString(),
      });
      setFormData({ ...formData, title: '', youtubeId: '' });
    } catch (err) { console.error(err); }
  };

  const handleAddQuiz = async (e) => {
    e.preventDefault();
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'quizzes'), {
        title: formData.title,
        question: formData.question,
        options: formData.options,
        correct: parseInt(formData.correct),
        createdAt: new Date().toISOString(),
      });
      setFormData({ ...formData, title: '', question: '', options: ['', '', '', ''], correct: 0 });
    } catch (err) { console.error(err); }
  };

  const deleteItem = async (col, id) => {
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id));
    } catch (err) { console.error(err); }
  };

  return (
    <div className="p-4 bg-white min-h-screen">
      <div className="flex items-center justify-between mb-6 bg-orange-50 p-4 rounded-2xl">
        <div className="flex items-center gap-2">
          <div className="bg-green-500 p-1.5 rounded-full text-white">
            <CheckCircle2 size={16} />
          </div>
          <div>
            <h2 className="text-sm font-black text-gray-800 leading-none">ADMIN AKTIF</h2>
            <p className="text-[9px] text-gray-400 mt-1 uppercase font-bold tracking-tighter">Manajemen Konten</p>
          </div>
        </div>
        <button onClick={handleLogoutAdmin} className="bg-white text-red-500 p-2 rounded-xl shadow-sm hover:bg-red-50 active:scale-90 transition-all">
          <LogOut size={18} />
        </button>
      </div>

      <div className="flex gap-2 mb-6 overflow-x-auto pb-1 scrollbar-hide">
        {['materi', 'video', 'quiz'].map((t) => (
          <button
            key={t}
            onClick={() => setTab(t)}
            className={`px-6 py-2.5 rounded-full text-[10px] font-black whitespace-nowrap uppercase tracking-[0.1em] transition-all shadow-sm ${tab === t ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-400'}`}
          >
            {t}
          </button>
        ))}
      </div>

      {tab === 'materi' && (
        <form onSubmit={handleAddMateri} className="space-y-3 mb-8 bg-gray-50 p-4 rounded-2xl border border-gray-100">
          <input
            placeholder="Judul Materi (Contoh: Orde Lama)"
            className="w-full p-4 border rounded-xl text-xs bg-white focus:border-orange-500 outline-none shadow-sm"
            value={formData.title}
            onChange={(e) => setFormData({ ...formData, title: e.target.value })}
            required
          />
          <textarea
            placeholder="Deskripsi Sejarah Singkat..."
            className="w-full p-4 border rounded-xl text-xs bg-white h-24 focus:border-orange-500 outline-none shadow-sm"
            value={formData.content}
            onChange={(e) => setFormData({ ...formData, content: e.target.value })}
            required
          />
          <button className="w-full bg-orange-600 text-white py-4 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-md active:scale-95 transition-all">
            Publikasikan Materi
          </button>
        </form>
      )}

      {tab === 'video' && (
        <form onSubmit={handleAddVideo} className="space-y-3 mb-8 bg-gray-50 p-4 rounded-2xl border border-gray-100">
          <input
            placeholder="Judul Video Dokumenter"
            className="w-full p-4 border rounded-xl text-xs bg-white focus:border-orange-500 outline-none shadow-sm"
            value={formData.title}
            onChange={(e) => setFormData({ ...formData, title: e.target.value })}
            required
          />
          <input
            placeholder="ID YouTube (Contoh: dQw4w9WgXcQ)"
            className="w-full p-4 border rounded-xl text-xs font-mono bg-white focus:border-orange-500 outline-none shadow-sm"
            value={formData.youtubeId}
            onChange={(e) => setFormData({ ...formData, youtubeId: e.target.value })}
            required
          />
          <button className="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-md active:scale-95 transition-all">
            Tambahkan Video
          </button>
        </form>
      )}

      {tab === 'quiz' && (
        <form onSubmit={handleAddQuiz} className="space-y-3 mb-8 bg-gray-50 p-4 rounded-2xl border border-gray-100">
          <input
            placeholder="Judul Kuis (Misal: Kuis Tokoh)"
            className="w-full p-4 border rounded-xl text-xs bg-white focus:border-orange-500 outline-none shadow-sm"
            value={formData.title}
            onChange={(e) => setFormData({ ...formData, title: e.target.value })}
            required
          />
          <textarea
            placeholder="Tulis Pertanyaan Kuis..."
            className="w-full p-4 border rounded-xl text-xs bg-white h-16 focus:border-orange-500 outline-none shadow-sm"
            value={formData.question}
            onChange={(e) => setFormData({ ...formData, question: e.target.value })}
            required
          />
          <div className="grid grid-cols-2 gap-2">
            {formData.options.map((opt, i) => (
              <input
                key={i}
                placeholder={`Pilihan ${i + 1}`}
                className="w-full p-3 border rounded-xl text-[10px] bg-white focus:border-orange-500 outline-none shadow-sm"
                value={opt}
                onChange={(e) => {
                  const newOpts = [...formData.options];
                  newOpts[i] = e.target.value;
                  setFormData({ ...formData, options: newOpts });
                }}
                required
              />
            ))}
          </div>
          <select 
            className="w-full p-4 border rounded-xl text-[10px] bg-white font-black text-gray-500 shadow-sm"
            value={formData.correct}
            onChange={(e) => setFormData({...formData, correct: e.target.value})}
          >
            <option value={0}>Jawaban: Opsi 1</option>
            <option value={1}>Jawaban: Opsi 2</option>
            <option value={2}>Jawaban: Opsi 3</option>
            <option value={3}>Jawaban: Opsi 4</option>
          </select>
          <button className="w-full bg-green-600 text-white py-4 rounded-xl font-black text-[10px] uppercase tracking-widest shadow-md active:scale-95 transition-all">
            Simpan ke Bank Soal
          </button>
        </form>
      )}

      <div className="space-y-2 pb-12">
        <h3 className="font-black text-[10px] text-gray-300 uppercase tracking-widest border-b pb-2 mb-4">Kelola Data Terdaftar</h3>
        {tab === 'materi' && materi.map(m => (
          <div key={m.id} className="flex justify-between items-center p-4 border-b border-gray-50 hover:bg-gray-50 rounded-xl transition-colors">
            <span className="text-[11px] font-bold text-gray-700 truncate pr-4">{m.title}</span>
            <button onClick={() => deleteItem('materi', m.id)} className="text-red-300 hover:text-red-500 active:scale-90 transition-all">
              <Trash2 size={16} />
            </button>
          </div>
        ))}
        {tab === 'video' && videos.map(v => (
          <div key={v.id} className="flex justify-between items-center p-4 border-b border-gray-50 hover:bg-gray-50 rounded-xl transition-colors">
            <span className="text-[11px] font-bold text-gray-700 truncate pr-4">{v.title}</span>
            <button onClick={() => deleteItem('videos', v.id)} className="text-red-300 hover:text-red-500 active:scale-90 transition-all">
              <Trash2 size={16} />
            </button>
          </div>
        ))}
        {tab === 'quiz' && quizzes.map(q => (
          <div key={q.id} className="flex justify-between items-center p-4 border-b border-gray-50 hover:bg-gray-50 rounded-xl transition-colors">
            <span className="text-[11px] font-bold text-gray-700 truncate pr-4">{q.title}</span>
            <button onClick={() => deleteItem('quizzes', q.id)} className="text-red-300 hover:text-red-500 active:scale-90 transition-all">
              <Trash2 size={16} />
            </button>
          </div>
        ))}
      </div>
    </div>
  );
};

export default App;